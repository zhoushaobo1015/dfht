<!doctype html>
<html lang="zh-cmn-Hans">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="./static/img/dfht_favicon.ico"/>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="./static/css/bootstrap-4.3.1.min.css">
    <link rel="stylesheet" href="./static/css/fontawesome-5.9.0.all.min.css">

    <!-- 单独引入 CSS -->
    <link rel="stylesheet" href="./static/css/style.css">
    <link rel="stylesheet" href="./static/css/bootstrap-datetimepicker.min.css">
    <link rel="stylesheet" href="./static/css/bootstrap-datepicker.css">
    <link href="./static/css/select2.min.css" rel="stylesheet" />



    <title>
        宏观择时【1】
    </title>
    
    <style>
        .nav-item {
            font-size: 36px;
            font-weight: bold;
        }
    </style>
    <style>
        /* Sidebar sizes when expanded and expanded */
        .sidebar-expanded {
            width: 150px;
        }
        .sidebar-collapsed {
            width: 60px;
        }
        #sidebar-container .list-group a {
            height: 50px;
            color: white;
        }
        /* Separators */
        .sidebar-separator-title {
            background-color: #333;
            height: 35px;
        }
        .sidebar-separator {
            background-color: #333;
            height: 25px;
        }
        #sidebar-container {
            min-height: 100%;
            background-color: #333;
            padding: 1px;
        }
        body {
            background: url("/static/img/bg01.jpg") center / cover no-repeat;
            min-height: 100vh;
        }
        .flex-grow {
            flex: 1;
        }
    </style>

</head>
<body class="d-flex flex-column">
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="./static/js/jquery-3.4.1.min.js"></script>
<script src="./static/js/popper-1.14.7.min.js"></script>
<script src="./static/js/bootstrap-4.3.1.min.js"></script>


<header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark my-2">
        <a class="navbar-brand" href="/">
            <img src="./static/img/dfht-logo.png" alt="logo" width="auto" height="60px"
                 class="d-inline-block align-top">
            <a style="font-family: SimSun; font-size: 2em; color:white;"></a>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav  nav-fill w-100" id="topmenu">
                
    <li class="nav-item">
    <a class="nav-link" href="/dfht/macro/">宏观择时</a>
</li>
<li class="nav-item">
    <a class="nav-link" href="/dfht/quant/">量化选股</a>
</li>
<li class="nav-item">
    <a class="nav-link" href="/dfht/arbitrage/">对冲套利</a>
</li>

            </ul>
            <ul class="navbar-nav nav-fill">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="far fa-user"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right animate slideIn"
                         aria-labelledby="navbarDropdown">
                        
                            <a class="dropdown-item" href="/dfht/updatemacro/">指标更新</a>
                            <a class="dropdown-item" href="/dfht/updatesector/">板块定制</a>
                            <a class="dropdown-item" href="/dfht/updatesetting/">更新设置</a>
                        
                        
                            <a class="dropdown-item" href="/users/profiles/">用户管理</a>
                        
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="/users/me/set">修改个人信息</a>
                        <a class="dropdown-item" href="/user_logout/">退出登录</a>
                    </div>
                </li>
                
    <li class="nav-item dropdown d-sm-block d-md-none" id="smallerscreenmenu">
        <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown"
           aria-haspopup="true" aria-expanded="false">模块菜单</a>
        <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
            
                <a class="dropdown-item" href="/dfht/macro/1">宏观指标</a>
            
                <a class="dropdown-item" href="/dfht/macro/2">市场趋势</a>
            
                <a class="dropdown-item" href="/dfht/macro/3">市场顶底</a>
            
                <a class="dropdown-item" href="/dfht/macro/4">市场估值</a>
            
        </div>
    </li><!-- Smaller devices menu END -->

            </ul>
        </div>
    </nav>
</header>

    <section class="container-fluid flex-grow">
        <div class="row" id="body-row">
            <div id="sidebar-container" class="sidebar-expanded d-none d-md-block">
                <ul class="list-group">
                    <a href="#" data-toggle="sidebar-colapse"
                       class="bg-dark list-group-item list-group-item-action d-flex align-items-center">
                        <div class="d-flex w-100 justify-content-start align-items-center">
                            <span id="collapse-icon" class="fa fa-angle-double-left fa-fw mr-3"></span>
                            <span id="collapse-text" class="menu-collapsed">收起菜单</span>
                        </div>
                    </a>
                    <li class="list-group-item sidebar-separator menu-collapsed"></li>
                    <li class="list-group-item sidebar-separator-title text-muted d-flex align-items-center menu-collapsed">
                        <small>宏观择时模块</small>
                    </li>
                    
                        <a href="/dfht/macro/1" class="bg-dark list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-start align-items-center">
                                <span class="fa fa-chart-pie mr-3"></span>
                                <span class="menu-collapsed">宏观指标</span>
                            </div>
                        </a>
                    
                        <a href="/dfht/macro/2" class="bg-dark list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-start align-items-center">
                                <span class="fas fa-signal mr-3"></span>
                                <span class="menu-collapsed">市场趋势</span>
                            </div>
                        </a>
                    
                        <a href="/dfht/macro/3" class="bg-dark list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-start align-items-center">
                                <span class="fas fa-chart-bar mr-3"></span>
                                <span class="menu-collapsed">市场顶底</span>
                            </div>
                        </a>
                    
                        <a href="/dfht/macro/4" class="bg-dark list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-start align-items-center">
                                <span class="fas fa-hand-holding-usd mr-3"></span>
                                <span class="menu-collapsed">市场估值</span>
                            </div>
                        </a>
                    
                </ul>
                <script>
                    // Collapse/Expand icon
                    
                    // Collapse click
                    $('[data-toggle=sidebar-colapse]').click(function () {
                        $('.menu-collapsed').toggleClass('d-none');
                        $('.sidebar-submenu').toggleClass('d-none');
                        $('.submenu-icon').toggleClass('d-none');
                        $('#sidebar-container').toggleClass('sidebar-expanded sidebar-collapsed');
                        // Treating d-flex/d-none on separators with title
                        var SeparatorTitle = $('.sidebar-separator-title');
                        if (SeparatorTitle.hasClass('d-flex')) {
                            SeparatorTitle.removeClass('d-flex');
                        } else {
                            SeparatorTitle.addClass('d-flex');
                        }
                        // Collapse/Expand icon
                        $('#collapse-icon').toggleClass('fa-angle-double-left fa-angle-double-right');
                    });
                </script>
            </div>
            <div class="container col bg-light mx-3">
                <div class="main3">
                    <button type="button" class="btn btn-primary btn-block" data-toggle="modal"  onclick="onClickMain3Btn1Fn()">强制更新</button>
                    <button type="button" class="btn btn-primary btn-block main3Btn2" onclick="onClickModule('date-list',true)">回退到指定日期</button>
                    <button type="button" class="btn btn-primary btn-block" onclick="onClickMain3Btn3Fn()">功能3</button>
                    <button type="button" class="btn btn-primary btn-block search1_btn" onclick="onClickMain3Btn4Fn()">功能4</button>
                    <button type="button" class="btn btn-primary btn-block search1_btn" onclick="onClickMain3Btn5Fn()">功能5</button>
                </div>
            </div>
            
            <!-- 沙漏弹窗 -->
            <div class="modal fade" id="main3Hourglass" tabindex="-1" role="dialog" aria-labelledby="main3Hourglass" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-body">
                            <!-- 沙漏弹窗 content -->
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal -->
            </div>

            <!-- 时间弹窗 -->
            <div class="modal fade" id="date-list" tabindex="-1" role="dialog" aria-labelledby="date-list" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-date-body">
                            <div class="modal-header">
                                <h4 class="modal-title">时间选择</h4>
                            </div>
                            <div class="input-group date form_date col-md-5" data-date="" data-date-format="yyyy-mm-dd" data-link-field="dtp_input2" data-link-format="yyyy-mm-dd">
                                <input class="page3_startdate page_datepicker" data-date-end-date="0d" value="请选择时间"/>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" onclick="onClickMain3Btn2Fn('date-list')">确认</button>
                            </div>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal -->
            </div>

            <!-- 查询1弹框 -->
            <div class="modal fade show" id="search1Popup" tabindex="-1" role="dialog" aria-labelledby="Hourglass" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-body">
                            <div class="selected_list_wrap">
                                <span>已选择</span>
                                <ul class="list-group">
                                    <!-- <li class="list-group-item">Cras justo odio</li>
                                    <li class="list-group-item">Dapibus ac facilisis in</li>
                                    <li class="list-group-item">Morbi leo risus</li> -->
                                </ul>
                                <button class="search1_confirm_btn btn btn-primary">选定</button>
                            </div>
                            <div class="selector_wrap selector1_wrap">
                                <select class="selector selector1">
                                </select>
                                <div class="selected_item_wrap">
                                    <ul class="list-group">
                    
                                    </ul>
                                </div>
                                <button type="button" class="add_btn btn btn-primary">加入</button>
                            </div>
                            <div class="selector_wrap selector2_wrap">
                                <select class="selector selector2">
                                </select>
                                <div class="selected_item_wrap">
                                    <ul class="list-group">
                                    </ul>
                                </div>
                                <button type="button" class="add_btn btn btn-primary">加入</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 查询2弹框 -->
            <div class="modal fade show" id="search2Popup" tabindex="-1" role="dialog" aria-labelledby="Hourglass" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-body">
                            <div class="selected_list_wrap">
                                <span>已选择</span>
                                <ul class="list-group"></ul>
                                <button class="search2_confirm_btn btn btn-primary">选定</button>
                            </div>
                            <div class="selector_wrap target_selector_wrap">
                                <select class="selector target_selector">
                                </select>
                                <div class="selected_item_wrap">
                                    <ul class="list-group">
                                    </ul>
                                </div>
                                <button type="button" class="add_btn btn btn-primary formAdd">加入</button>
                            </div>
                            <div class="radio_content_wrap">
                                <div class="data_preprocessing_radio_wrap">
                                    <span>数据预处理</span>
                                    <div class="radio_wrap">
                                        <div class="radio">
                                            <label>
                                                <input type="radio" name="optionsRadios" value="0" checked>不处理
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input type="radio" name="optionsRadios" value="1">删极值
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input type="radio" name="optionsRadios" value="2">削极值
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="standard_preprocessing_radio_wrap">
                                    <span>标准化处理</span>
                                    <div class="radio_wrap">
                                        <div class="radio">
                                            <label>
                                                <input type="radio" name="optionsRadios2" value="0" checked>不处理
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input type="radio" name="optionsRadios2" value="1">MinMax
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input type="radio" name="optionsRadios2" value="2">MeanStd
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input type="radio" name="optionsRadios2" value="3">maxabs
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input type="radio" name="optionsRadios2" value="4">1start
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script>
        var pics = ["./static/img/bg_0.jpg", "./static/img/bg_1.jpg", "./static/img/bg_2.jpg"];
        $(document).ready(function () {
            $("#topmenu li").removeClass('active');
            $("#sidebar-container a").removeClass('active');
            $("#smallerscreenmenu a").removeClass('active');
            $("#topmenu li").eq(0).addClass('active');
            $("#sidebar-container a").eq(1).addClass('active');
            $("#smallerscreenmenu a").eq(1).addClass('active');
            $("body").css("background-image", "url(" + pics[0] + ")");
        });
    </script>


<footer class="bg-dark text-white mt-3">
    <div class="d-flex justify-content-between mx-2 ">
        <div>这里是补充信息</div>
        <div>© 2019:<a href="http://www.orientever.com/index.php">
            东方恒泰投资管理有限公司</a>
        </div>
    </div>
</footer>

</body>
<!-- <script type="text/javascript" src="./static/js/bootstrap-datetimepicker.js" charset="UTF-8"></script> -->
<!-- <script type="text/javascript" src="./static/js/bootstrap-datetimepicker.js" charset="UTF-8"></script> -->
<!-- <script type="text/javascript" src="./static/js/locales/bootstrap-datetimepicker.fr.js" charset="UTF-8"></script> -->
<script src="./static/js/select2.min.js"></script>
<script src="./static/js/bootstrap-datepicker.js"></script>
<script src="./static/js/common.js"></script>
<script>

var select1SendData = null;

// 判断session中是否有内容如果没有请求数据
var sessionS = sessionStorage.getItem('myoptions');
if(sessionS === null || sessionS === "undefined" ){
    // let url = "/dfht/ajax_get_options/"; //上线解开这个即可
    let url = './static/json/myoptions.json'; //上线需要删除
    $.get(url,function(result){
        // sessionStorage.setItem("myoptions", result );     //上线解开
        sessionStorage.setItem("myoptions",JSON.stringify(result));
    });
}

var requestData = function(sendData){
    $(".selector.selector1.select2-hidden-accessible").val("请选择：").select2({});
    $(".selector.selector2.select2-hidden-accessible").val("请选择：").select2({});
    $(".selector.target_selector.select2-hidden-accessible").val("请选择：").select2({});
    $("#main3Hourglass").modal('toggle');
    $("#main3Hourglass .modal-body").html('<i class="fa fa-hourglass-start fa-spin fa-3x fa-fw margin-bottom"></i>');
    $.ajax({
        url: '/dfht/ajax_runfunctions/',
        type: "post",
        data: JSON.stringify( sendData ),
        success: function(res){
            let results = JSON.parse(res)
            if(results.status===200){
                $("#main3Hourglass .modal-body").html('<div class="wrappers"><div><i class="fa fa-check" aria-hidden="true" style="margin-right:10px;"></i>'+results.msg+'</div></div>')
            }else{
                $("#main3Hourglass .modal-body").html('<div class="wrappers"><div><i class="fa fa-times" aria-hidden="true" style="margin-right:10px;"></i>'+results.msg+'</div></div>')
            }
        },
        error: function(err){
            $("#main3Hourglass .modal-body").html('<div class="wrappers"><div><i class="fa fa-times" aria-hidden="true" style="margin-right:10px;"></i>更新失败</div></div>')
        }
    })
}

// 查询1
var onShowSelect1Get = function() {
    var sessionS = sessionStorage.getItem('myoptions');
    function appendData(selectData, className) {
        var frag = document.createDocumentFragment();
        if (selectData.length > 0) {
            frag.append($('<option>请选择：</option>')[0])
        }
        selectData.map(data => {
            frag.append($(`<option data-id=${data.id} value=${data.pinyin} data-pinyin=${data.pinyin}>${data.text}</option>`)[0])
        })
        $(`.${className}_wrap .${className}`).html(frag)
    }
    let { group, macro, sector, ticket } = JSON.parse( sessionS )
    // 查询1单标的选择数据
    let select1Data = [ ...macro, ...sector, ...ticket, ...group];
    // 查询1全部成分数据
    let select2Data = [...sector, ...group];
    appendData(select1Data, 'selector1')
    appendData(select2Data, 'selector2')
}

// 查询2
var onShowSelect2Get = function() {
    var sessionS = sessionStorage.getItem('myoptions');
    let {features} = JSON.parse(sessionS);
    var frag = document.createDocumentFragment();
    let selectData = $(".target_selector").on('select2:select', function(){
        let checkedItem = $(this).find('option:checked')
        let id = checkedItem.data('id')
        let pinyin = checkedItem.data('pinyin')
        let text = checkedItem.text()

        let canAdd = true
        let selector1Length = $('.selector1_wrap .list-group').children().length
        let selector2Length = $('.selector2_wrap .list-group').children().length
        if ('target_selector' === 'selector1') {
            // 如果selector2已经选了多个，并且selector1已经选了1个，不可继续添加
            if (selector2Length > 1 && selector1Length === 1) {
                canAdd = false
            }
        } else if ('target_selector' === 'selector2') {
            // 如果selector1已经选了多个，并且selector2已经选了1个，不可继续添加
            if (selector1Length > 1 && selector2Length === 1) {
                canAdd = false
            }
        }

        let exist = false
        $(`.target_selector_wrap .list-group`).children().each(function(i, item) {
            if (id === $(item).data('id')) {
                exist = true
            }
        })

        if (canAdd && !exist && text !== '请选择：') {
            $(`.target_selector_wrap .list-group`).append(`<li class="list-group-item" data-id=${id} data-pinyin=${pinyin}>${text}</li>`)
        }
    })

    if (selectData.length > 0) {
        frag.append($('<option>请选择：</option>')[0])
    }
    features.map(data => {
        frag.append($(`<option data-id=${data.id} val=${data.pinyin} data-pinyin=${data.pinyin}>${data.text}</option>`)[0])
    })
    $(`.target_selector_wrap .target_selector`).html(frag)
}

// main3 btn1
var onClickMain3Btn1Fn = function(){
    // 展示沙漏
    $("#main3Hourglass").modal('toggle');
    $("#main3Hourglass .modal-body").html('<i class="fa fa-hourglass-start fa-spin fa-3x fa-fw margin-bottom"></i>');
    requestData({name:"btn1"});
}

var onClickMain3Btn2Fn = function(id){
    $form_control_value = $(".form_date .page3_startdate").val();
    if($form_control_value === '请选择时间' || !$form_control_value){
        return false;
    }
    $("#"+id).modal('hide');
    $("#main3Hourglass").modal('toggle');
    $("#main3Hourglass .modal-body").html('<i class="fa fa-hourglass-start fa-spin fa-3x fa-fw margin-bottom"></i>');
    requestData({name:"btn2", targetday:$form_control_value});
}

var onClickMain3Btn3Fn = function(){
    $("#main3Hourglass").modal('toggle');
    $("#main3Hourglass .modal-body").html('<i class="fa fa-hourglass-start fa-spin fa-3x fa-fw margin-bottom"></i>');
    requestData({name:"btn3"});
}

// main3 btn4
var onClickMain3Btn4Fn = function(){
    // $("#search1Popup").attr('data-page', page)
    $("#search1Popup").modal('toggle');
    onShowSelect1Get();
    sessionStorage.setItem('btn_type',null);
}

// main3 btn5
var onClickMain3Btn5Fn = function(){
    $("#search1Popup").modal('toggle');
    onShowSelect1Get();
    sessionStorage.setItem("btn_type","btn5")
}

 // 查询1弹框选定按钮点击事件
 $('.search1_confirm_btn').click(function() {
    let selectedListGroup = $('#search1Popup .selected_list_wrap .list-group')
    let dataArr = getSelectedListData(selectedListGroup)

    // 获得弹框时从哪个page点击弹出的
    let page = $('#search1Popup').data('page')
    $(`.${page}_search1_data`).val(JSON.stringify(dataArr))
    // 清空数据
    selectedListGroup.empty()
    $('#search1Popup .selector1_wrap .selected_item_wrap ul').empty()
    $('#search1Popup .selector2_wrap .selected_item_wrap ul').empty()
    // 关闭弹框
    $("#search1Popup").modal('toggle');
    $('#search1Popup').removeAttr('data-page');

    if( sessionStorage.getItem("btn_type") === "btn5" ){
        $("#search2Popup").modal('toggle');
        onShowSelect2Get();
        select1SendData = dataArr;
        // $('#search2Popup .selector').val("").trigger("change");
    }else{
        // 获取到所有选中的数据
        requestData({name:"btn4",targets:dataArr});
    }
})


// 查询2弹框选定按钮点击事件
$('.search2_confirm_btn').click(function() {
    let selectedListGroup = $('#search2Popup .selected_list_wrap .list-group')
    let dataArr = getSelectedListData(selectedListGroup)
    // 获取数据预处理和标准化处理选中的值
    let checkedRadio = $('#search2Popup .data_preprocessing_radio_wrap .radio input:checked')
    let outliers = Number(checkedRadio.val())
    let checkedRadio2 = $('#search2Popup .standard_preprocessing_radio_wrap .radio input:checked')
    let standardize = Number(checkedRadio2.val());
    requestData({name:'btn5',targets:select1SendData,features:dataArr,outliers:outliers,standardize:standardize})
    // 清空数据
    selectedListGroup.empty()
    $('#search2Popup .target_selector_wrap .selected_item_wrap ul').empty()
    initRadio()
    // 关闭弹框
    $("#search2Popup").modal('toggle');
    $('#search2Popup').removeAttr('data-page')
})

// 初始化单选按钮
function initRadio() {
    $('.data_preprocessing_radio_wrap .radio:first input').attr('checked', 'checked')
    $('.standard_preprocessing_radio_wrap .radio:first input').attr('checked', 'checked')
}

// 获取选择的列表数据
function getSelectedListData(selectedListGroup) {
    let selectedItems = selectedListGroup.children()
    let dataArr = []
    Array.prototype.slice.call(selectedItems).map(item => {
        let id = $(item).data('id')
        let pinyin = $(item).data('pinyin')
        let text = $(item).text()
        dataArr.push({
            id,
            pinyin,
            text
        })
    })
    return dataArr
}



</script>


</html>